package org.example.geoblinker.presentation.features.map

import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp

@Composable
fun MapScreen(viewModel: MapViewModel) {
    val state by viewModel.state.collectAsState()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("Карта объектов") },
                actions = {
                    IconButton(onClick = { viewModel.onEvent(MapEvent.OnRefreshClick) }) {
                        Icon(Icons.Default.Refresh, contentDescription = "Обновить")
                    }
                }
            )
        }
    ) { padding ->
        Box(modifier = Modifier.padding(padding).fillMaxSize()) {
            if (state.isLoading) {
                CircularProgressIndicator(modifier = Modifier.align(Alignment.Center))
            }

            LazyColumn(modifier = Modifier.fillMaxSize()) {
                items(state.devices) { device ->
                    Card(
                        modifier = Modifier.fillMaxWidth().padding(8.dp).clickable { 
                            viewModel.onEvent(MapEvent.OnDeviceClick(device.id)) 
                        },
                        elevation = 4.dp
                    ) {
                        Column(modifier = Modifier.padding(16.dp)) {
                            Text(text = device.name, style = MaterialTheme.typography.h6)
                            Text(text = "Скорость: \${"%.1f".format(device.speed)} м/с")
                            Text(
                                text = if (device.isOnline) "В сети" else "Оффлайн",
                                color = if (device.isOnline) Color.Green else Color.Gray
                            )
                        }
                    }
                }
            }

            state.error?.let {
                Text(it, color = Color.Red, modifier = Modifier.align(Alignment.Center))
            }
        }
    }
}


package org.example.geoblinker.presentation.features.map

import org.example.geoblinker.presentation.core.*

data class MapDeviceUi(
    val id: String,
    val name: String,
    val lat: Double, 
    val lng: Double, 
    val speed: Double, 
    val isOnline: Boolean
)

data class MapState(
    val devices: List<MapDeviceUi> = emptyList(),
    val selectedDeviceId: String? = null,
    val isLoading: Boolean = false,
    val error: String? = null,
    val isFilterVisible: Boolean = false
) : UiState

sealed interface MapEvent : UiEvent {
    data class OnDeviceClick(val deviceId: String) : MapEvent
    data object OnRefreshClick : MapEvent
    data object OnToggleFilter : MapEvent
}

sealed interface MapEffect : UiEffect {
    data class ShowToast(val message: String) : MapEffect
    data class MoveCamera(val lat: Double, val lng: Double) : MapEffect
} 


package org.example.geoblinker.presentation.features.map

import org.example.geoblinker.domain.repository.DeviceRepository
import org.example.geoblinker.presentation.core.BaseViewModel
import kotlinx.coroutines.launch

class MapViewModel(
    private val repository: DeviceRepository
) : BaseViewModel<MapState, MapEvent, MapEffect>(MapState()) {

    init {
        loadDevices()
    }

    override fun onEvent(event: MapEvent) {
        when (event) {
            is MapEvent.OnDeviceClick -> {
                updateState { it.copy(selectedDeviceId = event.deviceId) }
                state.value.devices.find { it.id == event.deviceId }?.let { device ->
                    sendEffect(MapEffect.MoveCamera(device.lat, device.lng))
                }
            }
            MapEvent.OnRefreshClick -> loadDevices()
            MapEvent.OnToggleFilter -> updateState { it.copy(isFilterVisible = !it.isFilterVisible) }
        }
    }

    private fun loadDevices() {
        updateState { it.copy(isLoading = true) }
        scope.launch {
            try {
                val raw = repository.getDevices()
                val uiDevices = raw.map { 
                    MapDeviceUi(
                        id = it.id,
                        name = it.name,
                        lat = it.lat / 1_000_000.0, // Legacy Math
                        lng = it.lng / 1_000_000.0, // Legacy Math
                        speed = it.speed / 3.6,      // Legacy Math
                        isOnline = it.status == "online"
                    )
                }
                updateState { it.copy(devices = uiDevices, isLoading = false) }
            } catch (e: Exception) {
                updateState { it.copy(isLoading = false, error = e.message) }
                sendEffect(MapEffect.ShowToast("Ошибка загрузки данных"))
            }
        }
    }
}